---
layout: post
title:  网络传输协议
subtitle: tcp/udp/ip等
author: zql
date: 2020-05-20
header-img: img/network_post.jpg
catalog:  true
tags:
    - 计算机网络
---
### 目录
 - OSI七层模型
 - tcp四层模型
 - tcp建立和断开连接
 - tcp特性
 - tcp和udp区别

### OSI七层模型  
OSI七层模型及其包含的协议如下:
物理层: 通过媒介传输比特,确定机械及电气规范,传输单位为bit，主要包括的协议为：IEE802.3 CLOCK RJ45  
数据链路层: 将比特组装成帧和点到点的传递,传输单位为帧,主要包括的协议为MAC VLAN PPP  
网络层：负责数据包从源到宿的传递和网际互连，传输单位为包,主要包括的协议为IP ARP ICMP  
传输层：提供端到端的可靠报文传递和错误恢复，传输单位为报文,主要包括的协议为TCP UDP  
会话层：建立、管理和终止会话，传输单位为SPDU，主要包括的协议为RPC NFS  
表示层: 对数据进行翻译、加密和压缩,传输单位为PPDU，主要包括的协议为JPEG ASII  
应用层: 允许访问OSI环境的手段,传输单位为APDU，主要包括的协议为FTP HTTP DNS  
### tcp四层模型  
TCP/IP 4层模型包括：  
网络接口层：MAC VLAN  
网络层:IP ARP ICMP  
传输层:TCP UDP  
应用层:HTTP DNS SMTP  
### tcp建立和断开连接  
MTU(Maximum Transfer Unit)：最大传输单元  
MTU：每个数据包包含的数据最多可以有多少个字节，1.5K左右  
![avatar](/img/tcp_post.png)  
Client:发送syn=1,seq=x至server  SYN-SENT状态  
Server:发送syn=1,seq=y,ack=x+1至client  SYN-RECV状态（表明服务端可以接收客户端的数据）  
Client:发送ack=y+1,seq=x+1  至server  ESTABLISHED（表明客户端可以接收服务端的数据）  
Server： ESTABLISHED  
三次握手的原因：防止客户端发送的被阻塞的申请建立连接报文在传输结束之后被服务端接收，如果是两次握手，此时服务端会进入连接状态，一直等待客户端发送数据。
或者：如果两次握手，服务端在发送二次握手的报文之后进入连接状态，但服务器二次握手的报文可能丢失，此时客户端仍然没有进入连接状态，导致服务端一直保存“已建立“连接必要的资源，可能导致服务器崩溃。  
Client：发送fin=1,seq=x,ack=y  FIN_WAIT1状态 （告诉服务端自己已经没有剩余的数据发送，申请关闭连接）  
Server:ack=x+1  CLOSE_WAIT状态（告诉客户端收到申请，准备关闭连接）  
Client:  FIN_WAIT2状态  
Server:fin=1,ack=x+1,seq=y  LAST_ACK状态（将剩余的数据传输给客户端）  
Client:ack=y+1,seq=x+1  TIME_WAIT状态，等待2MSL（确认服务端收到了客户端最后的ack）  
TIME_WAIT作用：客户端最后一条ACK报文告诉服务端自己收到了服务端传输的最后数据，等待2MSL（最长数据包生命周期）原因：如果服务端最后没有收到客户端的ACK报文能够进行超时重传。  
处于TIME_WAIT时的服务端无法重新bind(),所有TCP服务器都应该指定SO_REUSEADDR套接字选项，以防止当套接字处于TIME_WAIT时bind()失败的情形出现。  
### tcp特性  
1.序列号，确认应答，超时重传：接收方收到数据后要发送序列号确认应答并告知发送方要发送的下一个数据。如果发送方没有接收到确认应答，则可能是数据丢失或确认应答丢失，发送方在等待一段时间后会进行重传，时间一般为2*RTT+偏差值。  
2.窗口传输：设置一个传输窗口大小，在窗口内，发送发不一定非要接收到确认应答才发送下一段数据，窗口大小就是无需等待确认而可发送的最大数据值。  
3.快速重传：如果发送方发送的数据丢失，后面每次传输接收方都会发送相同的序列号告诉发送方数据丢失，当发送方连续三次收到相同的应答（若不是数据丢失而是应答丢失不会重传，因为接收方已经收到了数据。三次：避免数据传输阻塞而非丢失造成的原因？说明并没有出现拥塞），发送方会重新发送数据。  
4.拥塞控制  
窗口传输提高了数据传输的效率，但如果窗口过大，发送方连续发送大量的数据会造成网络拥堵。  
a)慢启动：设置慢启动阈值，初始传输窗口为1，每经过一次确认应答窗口大小×2。  
b)拥塞控制：当窗口达到阈值，窗口大小不再指数增大，每经过一次RTT窗口大小+1。将超时重传看作拥塞，出现拥塞之后，将慢启动阈值设为当前窗口的一半，传输窗口置为1，重新开始慢启动过程。  
c)当发生快速重传时，将慢启动阈值设为当前窗口的一半，传输窗口设为阈值+3，然后进行拥塞控制。  
### tcp和udp的区别  
1.TCP建立会话是可靠传输，UDP不是  
2.UDP可以是一对一，多对一，一对多，TCP只是一对一建立连接  
3.TCP是可靠交付：无差错，不丢失，不重复，按序到达。UDP是尽最大努力交付，不保证可靠交付。  
4.TCP报文长度是动态的  
5.TCP有拥塞控制  
6.TCP首部开销大是20字节，UDP是8  
7.TCP侧重保证数据的完整性，UDP侧重实时性  
![avatar](/img/tcphead_post.png)  
![avatar](/img/udphead_post.png)  
