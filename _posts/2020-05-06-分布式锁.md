---
layout: post
title:  分布式锁
subtitle: 分布式锁概述、redis分布式锁实现
author: zql
date: 2020-05-06
header-img: img/caozuoxitong.jpg
catalog:  true
tags:
    - 数据库
---
### 目录  
 - 分布式锁概述
 - 分布式锁特点
 - redis分布式锁实现  

### 分布式锁概述  
分布式锁，是指在分布式的部署环境下，通过锁机制来让多客户端互斥的对共享资源进行访问。  
比如说在一个分布式系统中，多台机器上部署了多个服务，当客户端一个用户发起一个数据插入请求时，如果没有分布式锁机制保证，那么那多台机器上的多个服务可能进行并发插入操作，导致数据重复插入，对于某些不允许有多余数据的业务来说，这就会造成问题。而分布式锁机制就是为了解决类似这类问题，保证多个服务之间互斥的访问共享资源，如果一个服务抢占了分布式锁，其他服务没获取到锁，就不进行后续操作。大致意思如下图所示（不一定准确）：
![avatar](https://user-gold-cdn.xitu.io/2019/4/25/16a53749547937bb?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)  
### 分布式锁特点  
互斥性： 同一时刻只能有一个线程持有锁  
可重入性： 同一节点上的同一个线程如果获取了锁之后能够再次获取锁  
锁超时：和J.U.C中的锁一样支持锁超时，防止死锁  
高性能和高可用： 加锁和解锁需要高效，同时也需要保证高可用，防止分布式锁失效  
具备阻塞和非阻塞性：能够及时从阻塞状态中被唤醒  
[参考](https://juejin.im/post/5cc165816fb9a03202221dd5#heading-9)  
### redis分布式锁实现  
熟悉Redis的同学那么肯定对setNx(set if not exist)方法不陌生，如果不存在则更新，其可以很好的用来实现我们的分布式锁。对于某个资源加锁我们只需要
```
setNx resourceName value
```
复制代码这里有个问题，加锁了之后如果机器宕机那么这个锁就不会得到释放所以会加入过期时间，加入过期时间需要和setNx同一个原子操作，在Redis2.8之前我们需要使用Lua脚本达到我们的目的，但是redis2.8之后redis支持nx和ex操作是同一原子操作。
```
set resourceName value ex 5 nx
```
[参考](https://juejin.im/post/5bbb0d8df265da0abd3533a5)  
### 未完待续  
